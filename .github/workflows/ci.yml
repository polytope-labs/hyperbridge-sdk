name: CI

on:
    push:
        branches: [main]
    pull_request:
        branches: [main]

jobs:
    test:
        runs-on: ubuntu-latest
        steps:
            - uses: actions/checkout@v3
              with:
                  fetch-depth: 0

            - name: Set up Docker Compose
              uses: KengoTODA/actions-setup-docker-compose@v1
              with:
                  version: "2.20.2" # Specify a version

            - name: Setup Docker environment
              run: |
                  # Create temp directory for postgres data
                  mkdir -p /tmp/postgres-data

                    # Pass all required environment variables for docker-compose
                    echo "DB_USER=postgres" >> $GITHUB_ENV
                    echo "DB_PASS=postgres" >> $GITHUB_ENV
                    echo "DB_DATABASE=hyperbridge" >> $GITHUB_ENV
                    echo "DB_HOST=postgres" >> $GITHUB_ENV
                    echo "DB_PORT=5432" >> $GITHUB_ENV
                    echo "DB_PATH=/tmp/postgres-data" >> $GITHUB_ENV
                    echo "SUB_COMMAND=-f" >> $GITHUB_ENV
                    echo "SUBQL_WORKERS=1" >> $GITHUB_ENV
                    echo "SUBQL_BATCH_SIZE=5" >> $GITHUB_ENV

            - name: Start indexer stack
              run: |
                  cd packages/indexer

                  # Start only Postgres first
                  docker compose -f docker/docker-compose.testnet.yml up -d postgres

                  # Wait for PostgreSQL to be ready
                  echo "Waiting for PostgreSQL to initialize..."
                  for i in {1..20}; do
                    if docker exec docker-postgres-1 pg_isready -U postgres -h localhost; then
                      echo "PostgreSQL is ready"
                      break
                    fi
                    echo "Waiting for PostgreSQL... (attempt $i of 20)"
                    sleep 5
                  done

                  # Now start GraphQL engine
                  docker compose -f docker/docker-compose.testnet.yml up -d graphql-engine

                  # Wait for GraphQL engine
                  echo "Waiting for GraphQL engine to start..."
                  for i in {1..20}; do
                    if curl -s http://localhost:3000/graphql -o /dev/null; then
                      echo "GraphQL engine is up and running"
                      break
                    fi
                    echo "Waiting... (attempt $i of 20)"
                    sleep 5
                  done

                  # Finally start indexing nodes
                  docker compose -f docker/docker-compose.testnet.yml up -d indexer

            - name: Setup Node.js
              uses: actions/setup-node@v3
              with:
                  node-version: "18"

            - name: Setup PNPM
              uses: pnpm/action-setup@v2
              with:
                  version: 7

            - name: Install dependencies
              run: pnpm install

            - name: Build SDK
              run: pnpm --filter="@hyperbridge/sdk" build

            - name: Run SDK tests
              run: pnpm --filter="@hyperbridge/sdk" test
              env:
                  INDEXER_GRAPHQL_URL: http://localhost:3000/graphql
                  BSC_CHAPEL: ${{ secrets.BSC_CHAPEL }}
                  GNOSIS_CHIADO: ${{ secrets.GNOSIS_CHIADO }}
                  HYPERBRIDGE_GARGANTUA: ${{ secrets.HYPERBRIDGE_GARGANTUA }}
                  PRIVATE_KEY: ${{ secrets.PRIVATE_KEY }}
                  PING_MODULE_ADDRESS: ${{ secrets.PING_MODULE_ADDRESS }}

            - name: Run linter
              run: pnpm lint

            - name: Stop indexer stack
              if: always()
              run: |
                  cd packages/indexer
                  docker-compose -f docker/docker-compose.testnet.yml down

    # release:
    #     name: Release
    #     needs: test
    #     if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    #     runs-on: ubuntu-latest
    #     steps:
    #         - uses: actions/checkout@v3
    #           with:
    #               fetch-depth: 0
    #               token: ${{ secrets.GITHUB_TOKEN }}

    #         - name: Setup Node.js
    #           uses: actions/setup-node@v3
    #           with:
    #               node-version: "18"
    #               registry-url: "https://registry.npmjs.org"

    #         - name: Setup PNPM
    #           uses: pnpm/action-setup@v2
    #           with:
    #               version: 7

    #         - name: Install dependencies
    #           run: pnpm install

    #         - name: Setup Git User
    #           run: |
    #               git config --global user.name "GitHub Actions"
    #               git config --global user.email "actions@github.com"

    #         - name: Create Release Pull Request or Publish
    #           id: changesets
    #           uses: changesets/action@v1
    #           with:
    #               publish: pnpm release
    #               commit: "chore: version packages"
    #               title: "chore: version packages"
    #           env:
    #               GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
    #               NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}
