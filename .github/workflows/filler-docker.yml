name: "Publish @hyperbridge/filler"

on:
    push:
        tags:
            - "filler-v[0-9]+.[0-9]+.[0-9]+"

concurrency:
    group: release-${{ github.ref }}
    cancel-in-progress: true

jobs:
    build_and_publish:
        runs-on: ubuntu-latest
        steps:
            - name: Checkout sources
              uses: actions/checkout@v3
              with:
                  token: ${{ secrets.GH_TOKEN }}
                  submodules: recursive

            - uses: webfactory/ssh-agent@v0.5.4
              with:
                  ssh-private-key: "${{ secrets.SSH_KEY }}"

            - name: Set up Node.js
              uses: actions/setup-node@v3
              with:
                  node-version: "24"
                  registry-url: "https://registry.npmjs.org"

            - name: Install pnpm
              run: npm install -g pnpm@9.15.0

            - name: Extract version from tag
              id: get-version
              run: echo "VERSION=${GITHUB_REF#refs/tags/filler-v}" >> $GITHUB_ENV

            - name: Install dependencies
              run: pnpm install

            - name: Build SDK (dependency for filler)
              run: cd packages/sdk && pnpm build

            - name: Build Filler
              run: cd packages/filler && pnpm build

            - name: Login to Docker Hub
              uses: docker/login-action@v3
              with:
                  username: ${{ secrets.DOCKER_USERNAME }}
                  password: ${{ secrets.DOCKER_ACCESS_TOKEN }}

            - name: Set up Docker Buildx
              uses: docker/setup-buildx-action@v2

            - name: Build and push Docker image
              uses: docker/build-push-action@v4
              with:
                  context: .
                  file: ./packages/filler/scripts/Dockerfile
                  push: true
                  tags: |
                      polytopelabs/hyperbridge-filler:v${{ env.VERSION }}
                      polytopelabs/hyperbridge-filler:latest
                  platforms: linux/amd64
                  cache-from: type=gha
                  cache-to: type=gha,mode=max
