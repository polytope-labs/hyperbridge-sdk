{"version":3,"file":"init-controller.test.js","sourceRoot":"","sources":["../../src/controller/init-controller.test.ts"],"names":[],"mappings":"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","sourcesContent":["// Copyright 2020-2025 SubQuery Pte Ltd authors & contributors\n// SPDX-License-Identifier: GPL-3.0\n\nimport * as fs from 'fs';\nimport path from 'path';\nimport {makeTempDir} from '@subql/common';\nimport {copySync} from 'fs-extra';\nimport {rimraf} from 'rimraf';\nimport git from 'simple-git';\nimport {parseDocument, Document} from 'yaml';\nimport {isProjectSpecV0_2_0, isProjectSpecV1_0_0, ProjectSpecBase} from '../types';\nimport {\n  cloneProjectGit,\n  cloneProjectTemplate,\n  fetchExampleProjects,\n  prepare,\n  ExampleProjectInterface,\n  readDefaults,\n} from './init-controller';\n\nasync function testYAML(projectPath: string, project: ProjectSpecBase): Promise<{old: Document; new: Document}> {\n  const yamlPath = path.join(`${projectPath}`, `project.yaml`);\n  const manifest = await fs.promises.readFile(yamlPath, 'utf8');\n  const data = parseDocument(manifest);\n\n  const clonedData = data.clone();\n  clonedData.set('description', project.description ?? data.get('description'));\n\n  // network type should be collection\n  const network: any = clonedData.get('network');\n  network.set('endpoint', 'http://def not real endpoint');\n  clonedData.set('version', 'not real version');\n  clonedData.set('name', 'not real name');\n\n  if (isProjectSpecV1_0_0(project)) {\n    network.set('chainId', 'random chainId');\n  } else if (isProjectSpecV0_2_0(project)) {\n    network.set('genesisHash', 'random genesisHash');\n  }\n  return {\n    old: data,\n    new: clonedData,\n  };\n}\n\n// async\nconst fileExists = async (file: string): Promise<boolean> => {\n  return new Promise<boolean>((resolve, reject) => {\n    fs.access(file, fs.constants.F_OK, (err) => {\n      err ? reject(err) : resolve(true);\n    });\n  });\n};\n\njest.setTimeout(30000);\n\nconst projectSpec = {\n  name: 'mocked_starter',\n  endpoint: ['wss://rpc.polkadot.io/public-ws'],\n  specVersion: '1.0.0',\n  author: 'jay',\n  description: 'this is test for init controller',\n  chainId: '0x91b171bb158e2d3848fa23a9f1c25182fb8e20313b2c1eb49219da7a70ce90c3',\n};\n\ndescribe('Cli can create project', () => {\n  it('should resolve when starter project created via template', async () => {\n    const tempPath = await makeTempDir();\n    const projects = await fetchExampleProjects('polkadot', 'acala');\n    const projectPath = await cloneProjectTemplate(tempPath, projectSpec.name, projects[0]);\n    await prepare(projectPath, projectSpec);\n    await expect(fileExists(path.join(tempPath, `${projectSpec.name}`))).resolves.toEqual(true);\n  });\n\n  it('should resolve when starter project created via git', async () => {\n    const tempPath = await makeTempDir();\n    const projectPath = await cloneProjectGit(\n      tempPath,\n      projectSpec.name,\n      'https://github.com/subquery/subql-starter',\n      'v1.0.0'\n    );\n    await prepare(projectPath, projectSpec);\n    await expect(fileExists(path.join(tempPath, `${projectSpec.name}`))).resolves.toEqual(true);\n  });\n\n  it('throw error if .git exists in starter project', async () => {\n    const tempPath = await makeTempDir();\n    const projects = await fetchExampleProjects('polkadot', 'polkadot');\n    const projectPath = await cloneProjectTemplate(tempPath, projectSpec.name, projects[0]);\n    await prepare(projectPath, projectSpec);\n    await expect(fileExists(path.join(tempPath, `${projectSpec.name}/.git`))).rejects.toThrow();\n  });\n  it('YAML contains comments', async () => {\n    const localPath = await makeTempDir();\n    const tempPath = await makeTempDir();\n\n    // to pull from a commit that still uses project.yaml\n    const projects = await fetchExampleProjects('polkadot', 'polkadot');\n    const projectPath = path.join(localPath, projectSpec.name);\n    await git(tempPath).init().addRemote('origin', projects[0].remote);\n    await git(tempPath).raw('sparse-checkout', 'set', `${projects[0].path}`);\n    await git(tempPath).raw('pull', 'origin', 'd2868e9e46371f0ce45e52acae2ace6cb97296a0');\n\n    copySync(path.join(tempPath, `${projects[0].path}`), projectPath);\n    fs.rmSync(tempPath, {recursive: true, force: true});\n\n    const output = await testYAML(path.join(localPath, projectSpec.name), projectSpec);\n    expect(output.new.toJS().network.chainId).toBe('random chainId');\n    expect(output.new).not.toEqual(output.old);\n    expect(output.new.toString()).toContain('# The genesis hash of the network (hash of block 0)');\n\n    await rimraf(localPath);\n  });\n\n  it('prepare correctly applies project details', async () => {\n    const tempPath = await makeTempDir();\n    const projects = await fetchExampleProjects('polkadot', 'polkadot');\n    const project = projects.find((p) => p.name === 'Polkadot-starter')!;\n    const projectPath = await cloneProjectTemplate(tempPath, projectSpec.name, project);\n    await prepare(projectPath, projectSpec);\n    const {author, description} = await readDefaults(projectPath);\n\n    //spec version is  not returned from readDefaults\n    //expect(projectSpec.specVersion).toEqual(specVersion);\n    expect(projectSpec.author).toEqual(author);\n    expect(projectSpec.description).toEqual(description);\n    await rimraf(tempPath);\n  });\n\n  it('allow git from sub directory', async () => {\n    const tempPath = await makeTempDir();\n\n    const template: ExampleProjectInterface = {\n      name: 'Polkadot-starter',\n      description: '',\n      remote: 'https://github.com/subquery/subql-starter',\n      path: 'Polkadot/Polkadot-starter',\n    };\n\n    const projectPath = await cloneProjectTemplate(tempPath, projectSpec.name, template);\n    await prepare(projectPath, projectSpec);\n    await expect(fileExists(path.join(tempPath, `${projectSpec.name}`))).resolves.toEqual(true);\n  }, 5000000);\n});\n"]}